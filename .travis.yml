sudo: required

language: go

go:
  - 1.7

services:
  - docker

cache:
  yarn: true
  directories:
    - backend/vendor

env:
  global:
    - GOBUILD="linux-amd64 windows-amd64 darwin-amd64"
    # DOCKER_USER
    - secure: "XB/5pW++k4w4tx7rIYuuNW89Q784QYczG++lpQk1X/OGKCtJBfV2Ul7yU04KgRmxJDmAF/LCcpigxqrHcpUKo2o7p9jYNxQVMNpCbKA4ZMvuNumJa/2Li6c4kf4LJD4Yhg5LLYw9HmsOgLjCQ/dDOVhGgprkmzDWBBfJVDBte+SfqnDS5TM87d7gN40LRHBIIhiiJZlhrnjnKEgAnvNwxaZ1Oa1ncItt8WzCn8FjKzzUhTKFvEQhIX4he0USGypWUOy2Wgaqupkzwns14Z8fZ5C8o4qmgx6ZuEl6E6WmkF/rDT2FruMcE3K7eVLFYgl+aqi48L7o8bOXTFAkv+UjlcJGu8DvsBDTnr6bZ4e+dbzY3KxCZT3VyjteRfTMyv9Op7oVgt+oxR6vWgliofZk7T1rDCO1NUJpn1kooKQlZsE5SfQuHFiNxRlLuaRV5ZdANH9vonqdEyZC3OUWO3LqQYRhXakqe2uP+bjt85t/SIQZMGX1MLnU0T1HzPF3TaMMtr4SKt9gJPdyIxlXk8nagTdk6fRxRr6SHPKI9XiHS00hMFhQTiwpbRohJ7XnOwCGxs5aYsNYAml303vceuBvSUFAUn0F+Pm0REWwVNK+9MoGA3tlWgyW3DUkd3ZymhXjhmbR04wYQnIzcWdSTvpNmx3laDknyfOu4HVmzBBjQow="
    # DOCKER_EMAIL
    - secure: "Gy8e7tCRReU2JMd/QaDzRnXxqMndIFMk8g8JGm33IBUFl5hDJ/fPdzfPlk8gB6fwHM73vJMaR/QIxTWsgieznXnZTU7OZ9+TbYq5LvX7Y36rgLdSAhR4z3AQUE+gziDZvVF0d2LJ0VVVgrIP6QQ2MsRtnJbN4h3HhxLLeSaDAJw+PuMK9995YozELdCYAX/LJ9JK+/vA4Ub54y7h8dH39n3HyWyTuv3cFJ4IyBuO7xZ5GYDNAeLxww2XuYGu5d/xEfNn+4JXHAgGoVvnOAfy9A78E+o4fbPH8Fyubsfd5IGv5EgUnuP4Ec9ZcfxwtUIXyzhTlgTmlCKwtCFiBdKp6TsGx4QG4oKbr3VH7saSZc+O+pn4JHY9ZDs66mPY9aiTczCYdng4en4ut1jWhFAumLPO06Ndj7W3Tgmq6l/6AfK6QhcOeRHlLElIoTla5MZHQw+g1W/td3QObYXsGDP3QT+q0Xg5PNTspRxII4ouF5P3Ua9HhpM93TNQYNOta38szb/xhgzqbXpHb9nSPkgdyo+KX1vcYJiSyfxacNjmATvm9Gl6RaEVvF+NXRj0AN4vtOcFsTWW0OfTDTQJXJeYJfdvcmfsOevAclJ7rj4jv0HlUNbRuYQljo8XN29+Z5PQfJXRprK7lfKKUZHELhC4FQxDDqRLnMLs4TrsnHyGe5s="
    # DOCKER_PASS
    - secure: "akT8tWkHyi6TkARNA3S5XImAaEZ+sbUTuxUk6BkqbLR/035uZUMHrArP4ijE5oIzlvBkgcy/J9/PHjutZK+NE1FQCJZZAS1pM5I+nVWPPfI1L1ORvMrGN9jTitDk5YFdZfXnWswCHMC0u9Hjbzn+Do8zNBgMlFlUNwstVE6f0HpnotK8aAlhtHCFXSx3pqAYypLRCLAwhQ4rqlu22qUQqvsdeAJ8HXw8qMCJYknU2lYmYwfI+mfX8+0hFd5SKsi6Gtf2Y93c16ILE2jjrhlmvnww2L0Nr3QxOQN9NpZeRs2EedUAvPLIE+Ngp7JzLMQfH2yzFbYWF8p/vKkck9Q6K4Jf6MdCmHzjXJ7utJn+L4GDsB4f+Uj0iSlVC94epFu0zJocz4Mct3be9tNddgoPyIlO2oSHQGFaoO3iqIIPRVRcY1W1nyO4YmFuJuYgyqPbyXS3+sn1cL8/AZ7/9slkkO/8emdkMsjK/9UyaqtG4h5jdm1SYKk2k3eLcQkfpt/EKTjXoi8l/9bs5ehfUZRtVcpxhJ0ykz7yvg4/Q888QBqySDUa8WBBhovRQbYJOSudt2H9dp2RfypLVWRoCCW5/4cby2uhezSFzeaD7ofX8/R+D42K/d6vC53OS0rAZgQXLDjgIVz63ZtqQatZr2N6OwzAi8EPojXm4DiuHYkI/iM="

script:
  - GOBUILD=${GOBUILD} make -j build
  - ls -la backend/build

after_success:
  - export PR=https://api.github.com/repos/$TRAVIS_REPO_SLUG/pulls/$TRAVIS_PULL_REQUEST
  - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo `curl -s $PR | jq -r .head.ref`; fi)
  - if [[ "$TRAVIS_PULL_REQUEST" != "false" ]]; then make docker DOCKER_USER=$DOCKER_USER DOCKER_PASS=$DOCKER_PASS DOCKER_EMAIL=$DOCKER_EMAIL TAG=pr-$TRAVIS_PULL_REQUEST COMMIT=$TRAVIS_COMMIT; fi
  - if [[ "$TRAVIS_TAG" =~ ^v.*$ ]]; then make docker DOCKER_USER=$DOCKER_USER DOCKER_PASS=$DOCKER_PASS DOCKER_EMAIL=$DOCKER_EMAIL TAG=$TRAVIS_TAG COMMIT=$TRAVIS_COMMIT; fi
  - if [[ "$BRANCH" == "master" ]]; then make docker DOCKER_USER=$DOCKER_USER DOCKER_PASS=$DOCKER_PASS DOCKER_EMAIL=$DOCKER_EMAIL TAG=latest COMMIT=$TRAVIS_COMMIT; fi

deploy:
  - provider: releases
    api_key: ${GITHUB_API_KEY}
    file:
      - backend/build/hashi-ui-linux-amd64
      - backend/build/hashi-ui-windows-amd64
      - backend/build/hashi-ui-darwin-amd64
    skip_cleanup: true
    overwrite: true
    on:
      tags: true
